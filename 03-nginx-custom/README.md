# Step:03 Webサーバーをホストしてみよう・2

## 概要

前回のステップで、Web サーバーをホスティングしました。しかしあの状態で本当に自宅サーバーが運営できるのでしょうか。
少なくとも前回作成した Web サーバーには以下にあげるような問題がありました。

1. フォアグラウンドが占有されて何も操作できない
2. 任意のデータで Web サイトをホスティングできない
3. Web サーバーの設定を変更できない

今回のステップではこれらすべての問題を解決していきます。

## 1. バックグラウンドで動作させる

このセクションでは「フォアグラウンドが占有されて何も操作できない」という問題を解決します。

この問題を解決するにはいくつかの手法がありますが、最も簡単なのはコンテナをバックグラウンドで起動することでしょう。

`docker run` コマンドではコンテナをバックグラウンドで動作させるために`-d`(`--detach`)というオプションを用意しています。

以下にその実行例をあげてみます。`-d` オプションを追加しているため、このコンテナはバックグラウンドで動作します。

```shell
docker run --rm -d nginx:latest
```

実行中のコンテナを表示するには`docker ps` コマンドを利用します。（このコマンドも実はエイリアスで、本当のコマンドは`docker container ls` です。）

以下は上記のコマンドを実行後、`docker ps` を実行した例です。

```shell
$ docker ps
CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS        PORTS      NAMES
dbedc1bb189b   nginx:latest "/docker-entrypoint.…"   2 seconds ago   Up 1 second   80/tcp     <ランダムなコンテナ名>
```

これでコンテナが実行されていることが確認できました。

「実際にブラウザから接続をしてみましょう。」と言いたいところですが前述したコマンドではホストマシンから直接接続できません。Step:02 を参考にして接続できるようにしてみましょう！（答えは`answer.md` に書いてあります。）

### 停止方法

バックグラウンドで起動したコンテナについては、前回のように`CTRL + C` では停止させることができません。
このようなコンテナを停止する場合は、`docker stop` コマンドを実行します。（このコマンドも例によってエイリアスです。本当のコマンドは`docker container stop` です。）

`docker stop` を実行する前に、停止したいコンテナの ID もしくは名前を知る必要があります。`docker ps` コマンドを実行してコンテナのリストを表示します。

```shell
$ docker ps
CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS     NAMES
69c6c1838810   nginx:latest   "/docker-entrypoint.…"   3 seconds ago   Up 3 seconds   80/tcp    great_blackburn
```

今回の例では、停止させたいコンテナの`ID` が`69c6c1838810` で、`NAMES` に`great_blackburn` のため、以下のコマンドのいずれかを実行します。

```shell
docker stop 69c6c1838810
```
```shell
docker stop great_blackburn
```

停止しているか確認するために、もう一度`docker ps` を実行すると表示が消えていることがわかるでしょう。

## 2. nginx のコンテナにマウントする

このセクションでは、「任意のデータで Web サイトをホスティングできない」という問題を解決します。

コンテナにあるデータは一時的なもので、コンテナが破壊（停止ではない）されたときに同時にデータも消失します。
コンテナが削除された後もデータを保持しておきたい場合は、コンテナに対してファイルシステムをマウントすることでデータを永続化できます。

Docker では主にボリュームマウントとバインドマウントの2種類があります。（Linux においてのみ追加で`tmpfs` マウントが存在します。）

今回はバインドマウントを利用して、nginx で任意のデータを配信してみましょう。バインドマウントは、ホスト側のファイルをコンテナ側の指定されたパスに直接マウントします。

バインドマウントを利用する場合は、`docker run` コマンドに`-v` オプションを適用させます。

`-v` オプションの後には`ホスト側のパス:コンテナ側のパス` のようにコロンで区切ってマウントしたいパスを指定します。

```shell
-v ./03-nginx-custom/data:/usr/share/nginx/html
```

当然上記の状態ではコマンドにはならないため、前回のセクションを参考にしつつコマンドを組み立ててみましょう。（答えは`answer.md` に書いてあります。）

この例では、リポジトリのルートから見て`./03-nginx-custom/data` の中身をコンテナの`/usr/share/nginx/html` にマウントをしています。

このバインドマウントをしたコンテナを起動したあとに、`./03-nginx-custom/data/index.html` の中身を書き換えてみましょう。

書き換えてからブラウザをリロードしてみると、書き換えた内容がそのまま反映されていることがわかるでしょう。（つまり、コンテナ内部とローカルのデータが同期している）

次のセクションへ移る前にコンテナを削除しておきましょう。ワンライナーがお好みの方は以下のコマンドで削除できます。nginx:latest イメージを利用した実行中のコンテナ全てが削除されるので注意してください。

```shell
docker ps --format json | grep "nginx:latest" | jq ".ID" | xargs docker stop
```

## 3. nginx のコンフィグを書いてマウントしてみよう

このセクションでは、「Web サーバーの設定を変更できない」という問題を解決します。
この問題に関しては前回のセクションの同じ解決方法を取ることができます。今回の勉強会は自宅サーバー入門ということなので nginx の設定を書き換えてみるということをします。

今回は例として Basic 認証を挟んでみましょう。

以下のコマンドをリポジトリルートから実行して、`.htpasswd` ファイルを作成してください。`USERNAME` と`PASSWORD` の部分は好きなものに変えてください。（この後接続するときにこの認証情報で接続します。）

```shell
docker run --rm -it httpd:latest htpasswd -nb USERNAME PASSWORD > ./03-nginx-custom/secret/.htpasswd
```

次にコンフィグファイルを作成します。

nginx で Basic 認証を挟むには以下の項目をコンフィグのどこかに記述する必要があります。
コンフィグファイルは`./03-nginx-custom/config/custom.conf` にありますが、コンフィグファイル内のどこに書くべきかは自分で考えてください。（調べても OK！）

```
auth_basic "Restricted Content";
auth_basic_user_file /etc/nginx/.htpasswd;
```


作成した認証情報と変更したコンフィグファイルを nginx のコンテナにバインドしてみましょう。

バインドのオプション`-v` は複数個つけることができます。(`-p` も複数回呼ぶことができます。)

```shell
-v ./03-nginx-custom/data:/usr/share/nginx/html -v ./03-nginx-custom/config:/etc/nginx/conf.d -v ./03-nginx-custom/secret/.htpasswd:/etc/nginx/.htpasswd
```

例によってオプションのみの不完全なコマンドなため、自力でコマンドを組み立ててみてください。
